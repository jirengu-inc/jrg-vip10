<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>server-mock使用说明</title>
<style>
  body {
    background: black;
  }
  li {
    list-style: none;
    text-align: center;
    padding: 10px;
    width: 500px;
    color: white;
    font-family: '微软雅黑';
  }
  #gc {
    position: absolute;
    width: 600px;
    height: 500px;
    overflow: hidden;
    top: 160px;
    left: 50%;
    margin-left: -300px;
    padding-top: 20px; 
  }
  ul {
    position: absolute;
    padding-top: 340px;
    width: 300px;
  }
  audio {
    width: 620px;
    height: 620px;
    border-radius: 620px;
    display: block;
    margin: 0 auto;
    background-repeat: no-repeat;
    background-size: contain;
    opacity: 0.5;
    padding: 120px;
  }
  p {
    text-align: center;
  }
  .move {
    transition: top 1s;
  }

</style>
</head>
<body>
  <button id="btn">点击播放随机音乐</button>
  <audio src="http://yinyueshiting.baidu.com/data2/music/123847299/1038997133200128.mp3?xcode=732c8daf28d007439824035d6041d0a0" controls="controls" autoplay="autoplay"></audio>
  <p id="info"></p>
  <div id="gc">
    <ul id="ct" class="move">
    </ul>
  </div>
  <script> 
  var btn = document.querySelector('#btn');
  var audio = document.querySelector('audio');
  var ct = document.querySelector('#ct');
  
  btn.addEventListener('click',function(){
    var song = document.createElement('script');
    song.src = 'http://api.jirengu.com/fm/getSong.php?channel=4&callback=getSong';
    document.body.appendChild(song);  
    document.body.removeChild(song);
    ct.innerHTML = '';
  })

  function getSong(json){
    console.log(json);
    a = json.song[0]
    var p = document.createElement('p');
    audio.src = a.url

    // 获取歌词
    var xhr = new XMLHttpRequest();
    var lrc = a.lrc;
    xhr.onreadystatechange = function(){
      if(xhr.readyState === 4 && xhr.status === 200){
        lyc(xhr.responseText);
        audio.style.backgroundImage = 'url' + '(' + a.picture + ')';
      }
    }
    xhr.open('get', lrc, true)
    xhr.responseType = 'text'
    xhr.send();
  }


  // 歌词处理函数
  
  function lyc(text){
    var lyric = text.split('\n');
    console.log(lyric);
    var result = [];
    var reg = /(\d{2}:{1}\d{2}.{1}\d{2})+/g;
    lyric.forEach(function(e, i, a){
      if(reg.test(lyric[i]) && lyric[i].match(reg).length === 1){
        var a = [];
        a[0] = lyric[i].match(reg)[0];
        a[1] = lyric[i].substring(lyric[i].lastIndexOf(']')+1, lyric[i].length);
        result.push(a);
      }else if(reg.test(lyric[i]) && lyric[i].match(reg).length > 1){
        lyric[i].match(reg).forEach(function(e1, i1, a1){
          var b = [];
          b.push(lyric[i].match(reg)[i1]);
          b.push(lyric[i].substring(lyric[i].lastIndexOf(']')+1, lyric[i].length));
          result.push(b);
        })
      } 
    })
    result.forEach(function(e2, i2, a2){
      a2[i2][0] = parseFloat(a2[i2][0].substring(3, a2[i2][0].length))+parseInt(a2[i2][0])*60;
      console.log(parseFloat(a2[i2][0].toString().match(/\d+\.?\d{0,2}/)))
    }) 
    result = result.sort(function(a, b){
      return a[0] - b[0];
    })
    var artist = document.createElement('li');    
    result.forEach(function(e3, i3, a3){
        var li = document.createElement('li');
        li.innerText = result[i3][1]
        ct.appendChild(li);
    })
    audio.ontimeupdate = function(){
      for(var x = 0; x < result.length; x++){
        if(this.currentTime > result[x][0]){
          ct.style.top = -x*40+'px';
          ct.childNodes[x].style.color = 'red';
          var now = document.querySelectorAll('#ct li');
          if(this.currentTime - result[x][0] > result[x+1][0] - result[x][0]){
            now[x].style.color = 'white';
          }
        }
      }
    }
  }
  </script>


</body>
</html>